name: Log Validation CI/CD

on:
  push:
    branches:
      - main
      - develop
      - 'claude/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      verbose_logging:
        description: 'Enable verbose logging'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # Job 1: Validate PowerShell Script Logging
  validate-script-logging:
    name: Validate Script Logging
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          Write-Host "===========================================" -ForegroundColor Cyan
          Write-Host "Setting up test environment for log validation" -ForegroundColor Cyan
          Write-Host "===========================================" -ForegroundColor Cyan

          # Create required directories
          $directories = @(
              "${{ github.workspace }}\logs",
              "${{ github.workspace }}\transcripts",
              "${{ github.workspace }}\test-results",
              "${{ github.workspace }}\validation-results"
          )

          foreach ($dir in $directories) {
              New-Item -ItemType Directory -Force -Path $dir | Out-Null
              Write-Host "Created directory: $dir" -ForegroundColor Green
          }

          # Set environment variables
          [Environment]::SetEnvironmentVariable("LOG_PATH", "${{ github.workspace }}\logs", "Process")
          [Environment]::SetEnvironmentVariable("TRANSCRIPT_PATH", "${{ github.workspace }}\transcripts", "Process")
          [Environment]::SetEnvironmentVariable("TEST_RESULTS_PATH", "${{ github.workspace }}\test-results", "Process")

          Write-Host "Environment setup completed" -ForegroundColor Green
        shell: pwsh

      - name: Test logging module
        run: |
          Write-Host "===========================================" -ForegroundColor Cyan
          Write-Host "Testing logging module functionality" -ForegroundColor Cyan
          Write-Host "===========================================" -ForegroundColor Cyan

          # Import and test the logging module
          . "${{ github.workspace }}\scripts\Write-AuditLog.ps1"

          # Initialize logging
          Initialize-AuditLogging -ScriptName "LogValidationTest" -EnableTranscript

          # Test different log levels
          Write-AuditLog -Message "Testing Info level logging" -Level Info
          Write-AuditLog -Message "Testing Warning level logging" -Level Warning
          Write-AuditLog -Message "Testing Error level logging" -Level Error
          Write-AuditLog -Message "Testing Success level logging" -Level Success
          Write-AuditLog -Message "Testing Debug level logging" -Level Debug -Verbose
          Write-AuditLog -Message "Testing Verbose level logging" -Level Verbose -Verbose

          # Stop logging
          Stop-AuditLogging -ScriptName "LogValidationTest"

          Write-Host "Logging module test completed" -ForegroundColor Green
        shell: pwsh

      - name: Run scripts with logging validation
        run: |
          Write-Host "===========================================" -ForegroundColor Cyan
          Write-Host "Running scripts and validating log creation" -ForegroundColor Cyan
          Write-Host "===========================================" -ForegroundColor Cyan

          $scripts = @(
              @{Name="win-audit.ps1"; RequiresAdmin=$true},
              @{Name="Test-EventIDGeneration.ps1"; RequiresAdmin=$true},
              @{Name="Generate-SyntheticLogs.ps1"; RequiresAdmin=$false}
          )

          $validationResults = @()

          foreach ($script in $scripts) {
              Write-Host "`nTesting: $($script.Name)" -ForegroundColor Yellow

              $scriptPath = "${{ github.workspace }}\scripts\$($script.Name)"

              if (Test-Path $scriptPath) {
                  $startTime = Get-Date
                  $logCountBefore = (Get-ChildItem "${{ github.workspace }}\logs" -Filter "*.log" -ErrorAction SilentlyContinue).Count
                  $transcriptCountBefore = (Get-ChildItem "${{ github.workspace }}\transcripts" -Filter "*.txt" -ErrorAction SilentlyContinue).Count

                  try {
                      # Run the script
                      if ($script.Name -eq "Generate-SyntheticLogs.ps1") {
                          & $scriptPath -EventCount 5 -Verbose
                      } else {
                          & $scriptPath -Verbose
                      }

                      $executionStatus = "Success"
                  } catch {
                      Write-Warning "Script execution failed: $_"
                      $executionStatus = "Failed"
                  }

                  $endTime = Get-Date
                  $logCountAfter = (Get-ChildItem "${{ github.workspace }}\logs" -Filter "*.log" -ErrorAction SilentlyContinue).Count
                  $transcriptCountAfter = (Get-ChildItem "${{ github.workspace }}\transcripts" -Filter "*.txt" -ErrorAction SilentlyContinue).Count

                  $result = @{
                      ScriptName = $script.Name
                      ExecutionStatus = $executionStatus
                      Duration = ($endTime - $startTime).TotalSeconds
                      LogsCreated = ($logCountAfter - $logCountBefore)
                      TranscriptsCreated = ($transcriptCountAfter - $transcriptCountBefore)
                      Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
                  }

                  $validationResults += $result

                  # Display result
                  Write-Host "  Status: $executionStatus" -ForegroundColor $(if($executionStatus -eq "Success"){"Green"}else{"Red"})
                  Write-Host "  Logs created: $($result.LogsCreated)"
                  Write-Host "  Transcripts created: $($result.TranscriptsCreated)"
              } else {
                  Write-Warning "Script not found: $scriptPath"
              }
          }

          # Save validation results
          $validationResults | ConvertTo-Json -Depth 3 | Out-File "${{ github.workspace }}\validation-results\script-validation.json"

          Write-Host "`nScript execution validation completed" -ForegroundColor Green
        shell: pwsh
        continue-on-error: true

      - name: Comprehensive log validation
        run: |
          Write-Host "===========================================" -ForegroundColor Cyan
          Write-Host "Performing comprehensive log validation" -ForegroundColor Cyan
          Write-Host "===========================================" -ForegroundColor Cyan

          $validationReport = @{
              Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              LogValidation = @{
                  LogFiles = @()
                  TranscriptFiles = @()
                  TotalLogFiles = 0
                  TotalTranscriptFiles = 0
                  TotalLogSize = 0
                  TotalTranscriptSize = 0
                  ValidationTests = @()
              }
          }

          # Validate log files
          $logFiles = Get-ChildItem "${{ github.workspace }}\logs" -Filter "*.log" -ErrorAction SilentlyContinue
          $validationReport.LogValidation.TotalLogFiles = $logFiles.Count

          foreach ($log in $logFiles) {
              $content = Get-Content $log.FullName -Raw
              $lineCount = (Get-Content $log.FullName).Count
              $size = $log.Length

              $logInfo = @{
                  FileName = $log.Name
                  Size = $size
                  LineCount = $lineCount
                  HasContent = $size -gt 0
                  HasTimestamps = $content -match '\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}'
                  HasLogLevels = $content -match '\[(Info|Warning|Error|Debug|Verbose|Success)\]'
                  Path = $log.FullName
              }

              $validationReport.LogValidation.LogFiles += $logInfo
              $validationReport.LogValidation.TotalLogSize += $size

              Write-Host "Validated log: $($log.Name) - Size: $size bytes, Lines: $lineCount" -ForegroundColor White
          }

          # Validate transcript files
          $transcriptFiles = Get-ChildItem "${{ github.workspace }}\transcripts" -Filter "*.txt" -ErrorAction SilentlyContinue
          $validationReport.LogValidation.TotalTranscriptFiles = $transcriptFiles.Count

          foreach ($transcript in $transcriptFiles) {
              $size = $transcript.Length

              $transcriptInfo = @{
                  FileName = $transcript.Name
                  Size = $size
                  HasContent = $size -gt 0
                  Path = $transcript.FullName
              }

              $validationReport.LogValidation.TranscriptFiles += $transcriptInfo
              $validationReport.LogValidation.TotalTranscriptSize += $size

              Write-Host "Validated transcript: $($transcript.Name) - Size: $size bytes" -ForegroundColor White
          }

          # Perform validation tests
          $tests = @(
              @{
                  Name = "Log files created"
                  Passed = $validationReport.LogValidation.TotalLogFiles -gt 0
                  Expected = "At least 1 log file"
                  Actual = "$($validationReport.LogValidation.TotalLogFiles) log files"
              },
              @{
                  Name = "Transcript files created"
                  Passed = $validationReport.LogValidation.TotalTranscriptFiles -gt 0
                  Expected = "At least 1 transcript file"
                  Actual = "$($validationReport.LogValidation.TotalTranscriptFiles) transcript files"
              },
              @{
                  Name = "Logs have content"
                  Passed = $validationReport.LogValidation.TotalLogSize -gt 0
                  Expected = "Non-empty log files"
                  Actual = "Total size: $($validationReport.LogValidation.TotalLogSize) bytes"
              },
              @{
                  Name = "Logs have proper formatting"
                  Passed = ($validationReport.LogValidation.LogFiles | Where-Object { $_.HasTimestamps -and $_.HasLogLevels }).Count -gt 0
                  Expected = "Timestamps and log levels in logs"
                  Actual = "$(($validationReport.LogValidation.LogFiles | Where-Object { $_.HasTimestamps -and $_.HasLogLevels }).Count) properly formatted logs"
              }
          )

          $validationReport.LogValidation.ValidationTests = $tests

          # Calculate overall validation status
          $passedTests = ($tests | Where-Object { $_.Passed }).Count
          $totalTests = $tests.Count
          $validationReport.ValidationStatus = if ($passedTests -eq $totalTests) { "PASSED" } else { "FAILED" }
          $validationReport.TestsSummary = "$passedTests/$totalTests tests passed"

          # Save validation report
          $validationReport | ConvertTo-Json -Depth 4 | Out-File "${{ github.workspace }}\validation-results\comprehensive-validation.json"

          # Display validation summary
          Write-Host "`n===========================================" -ForegroundColor Cyan
          Write-Host "Validation Summary" -ForegroundColor Cyan
          Write-Host "===========================================" -ForegroundColor Cyan

          foreach ($test in $tests) {
              $color = if ($test.Passed) { "Green" } else { "Red" }
              $status = if ($test.Passed) { "PASS" } else { "FAIL" }
              Write-Host "[$status] $($test.Name)" -ForegroundColor $color
              Write-Host "  Expected: $($test.Expected)"
              Write-Host "  Actual: $($test.Actual)"
          }

          Write-Host "`nOverall Status: $($validationReport.ValidationStatus)" -ForegroundColor $(if($validationReport.ValidationStatus -eq "PASSED"){"Green"}else{"Red"})
          Write-Host "Tests Passed: $($validationReport.TestsSummary)" -ForegroundColor White

          # Fail the job if validation failed
          if ($validationReport.ValidationStatus -ne "PASSED") {
              throw "Log validation failed: $($validationReport.TestsSummary)"
          }
        shell: pwsh

      - name: Generate validation report
        if: always()
        run: |
          Write-Host "===========================================" -ForegroundColor Cyan
          Write-Host "Generating Final Validation Report" -ForegroundColor Cyan
          Write-Host "===========================================" -ForegroundColor Cyan

          # Combine all validation results
          $scriptValidation = if (Test-Path "${{ github.workspace }}\validation-results\script-validation.json") {
              Get-Content "${{ github.workspace }}\validation-results\script-validation.json" -Raw | ConvertFrom-Json
          } else { @() }

          $comprehensiveValidation = if (Test-Path "${{ github.workspace }}\validation-results\comprehensive-validation.json") {
              Get-Content "${{ github.workspace }}\validation-results\comprehensive-validation.json" -Raw | ConvertFrom-Json
          } else { @{} }

          # Create markdown report
          $markdown = @"
# Log Validation Report

**Workflow:** ${{ github.workflow }}
**Run:** #${{ github.run_number }}
**Commit:** ${{ github.sha }}
**Branch:** ${{ github.ref_name }}
**Timestamp:** $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")

## Validation Summary

| Metric | Value |
|--------|-------|
| Total Log Files | $($comprehensiveValidation.LogValidation.TotalLogFiles) |
| Total Transcript Files | $($comprehensiveValidation.LogValidation.TotalTranscriptFiles) |
| Total Log Size | $($comprehensiveValidation.LogValidation.TotalLogSize) bytes |
| Validation Status | **$($comprehensiveValidation.ValidationStatus)** |
| Tests Passed | $($comprehensiveValidation.TestsSummary) |

## Script Execution Results

| Script | Status | Logs Created | Transcripts Created |
|--------|--------|--------------|---------------------|
$(
    $scriptValidation | ForEach-Object {
        "| $($_.ScriptName) | $($_.ExecutionStatus) | $($_.LogsCreated) | $($_.TranscriptsCreated) |"
    }
)

## Validation Tests

| Test | Status | Details |
|------|--------|---------|
$(
    $comprehensiveValidation.LogValidation.ValidationTests | ForEach-Object {
        $status = if ($_.Passed) { "✅ PASS" } else { "❌ FAIL" }
        "| $($_.Name) | $status | Expected: $($_.Expected), Actual: $($_.Actual) |"
    }
)

## Log Files Created

| File Name | Size | Lines | Has Timestamps | Has Log Levels |
|-----------|------|-------|----------------|----------------|
$(
    $comprehensiveValidation.LogValidation.LogFiles | ForEach-Object {
        $timestamps = if ($_.HasTimestamps) { "✅" } else { "❌" }
        $levels = if ($_.HasLogLevels) { "✅" } else { "❌" }
        "| $($_.FileName) | $($_.Size) bytes | $($_.LineCount) | $timestamps | $levels |"
    }
)
"@

          # Save markdown report
          $markdown | Out-File "${{ github.workspace }}\validation-results\VALIDATION_REPORT.md"

          # Display report
          Get-Content "${{ github.workspace }}\validation-results\VALIDATION_REPORT.md"
        shell: pwsh

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: |
            logs/
            transcripts/
            validation-results/
            test-results/

      - name: Comment on PR with validation results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'validation-results/VALIDATION_REPORT.md';

            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }