name: PowerShell Scripts Testing with Logging

on:
  push:
    branches:
      - main
      - develop
      - 'claude/**'
    paths:
      - 'scripts/*.ps1'
      - '.github/workflows/powershell-scripts-test.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'scripts/*.ps1'
  workflow_dispatch:
    inputs:
      enable_verbose_logging:
        description: 'Enable verbose logging'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # Job 1: Test all PowerShell scripts directly on Windows
  test-powershell-scripts:
    name: Test PowerShell Scripts
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup logging directory
        run: |
          Write-Host "Setting up logging infrastructure..." -ForegroundColor Cyan
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\logs"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\test-results"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\transcripts"

          # Set environment variables for logging
          $env:LOG_PATH = "${{ github.workspace }}\logs"
          $env:TRANSCRIPT_PATH = "${{ github.workspace }}\transcripts"
          $env:TEST_RESULTS_PATH = "${{ github.workspace }}\test-results"

          [Environment]::SetEnvironmentVariable("LOG_PATH", $env:LOG_PATH, "Process")
          [Environment]::SetEnvironmentVariable("TRANSCRIPT_PATH", $env:TRANSCRIPT_PATH, "Process")
          [Environment]::SetEnvironmentVariable("TEST_RESULTS_PATH", $env:TEST_RESULTS_PATH, "Process")

          Write-Host "Log directories created successfully" -ForegroundColor Green
        shell: pwsh

      - name: Enable PowerShell transcription
        run: |
          Write-Host "Configuring PowerShell transcription..." -ForegroundColor Cyan

          # Create PowerShell profile if it doesn't exist
          $profilePath = [System.IO.Path]::GetDirectoryName($PROFILE.AllUsersAllHosts)
          if (-not (Test-Path $profilePath)) {
              New-Item -ItemType Directory -Force -Path $profilePath
          }

          # Enable transcription for this session
          Start-Transcript -Path "${{ github.workspace }}\transcripts\session-$(Get-Date -Format 'yyyyMMdd-HHmmss').txt" -Append

          Write-Host "Transcription enabled" -ForegroundColor Green
        shell: pwsh

      - name: Test win-audit.ps1 with logging
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Testing: win-audit.ps1" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan

          $logFile = "${{ github.workspace }}\logs\win-audit-test-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"
          $transcriptFile = "${{ github.workspace }}\transcripts\win-audit-$(Get-Date -Format 'yyyyMMdd-HHmmss').txt"

          # Start transcript for this specific script
          Start-Transcript -Path $transcriptFile

          try {
              # Run the script with verbose output and capture all streams
              $scriptPath = "${{ github.workspace }}\scripts\win-audit.ps1"

              # Test if script exists and is valid
              if (Test-Path $scriptPath) {
                  Write-Host "Script found at: $scriptPath" -ForegroundColor Green

                  # Run syntax check
                  $syntaxErrors = $null
                  $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $scriptPath -Raw), [ref]$syntaxErrors)

                  if ($syntaxErrors.Count -eq 0) {
                      Write-Host "Syntax check passed" -ForegroundColor Green

                      # Execute with logging
                      & $scriptPath -Verbose *>&1 | Tee-Object -FilePath $logFile

                      Write-Host "Script executed successfully" -ForegroundColor Green
                  } else {
                      Write-Host "Syntax errors found:" -ForegroundColor Red
                      $syntaxErrors | ForEach-Object { Write-Host $_ -ForegroundColor Red }
                      throw "Syntax validation failed"
                  }
              } else {
                  throw "Script not found: $scriptPath"
              }
          } catch {
              Write-Host "Error executing script: $_" -ForegroundColor Red
              Add-Content -Path $logFile -Value "ERROR: $_"
              throw
          } finally {
              Stop-Transcript
          }
        shell: pwsh
        continue-on-error: true

      - name: Test SysmonLikeAudit.ps1 with logging
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Testing: SysmonLikeAudit.ps1" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan

          $logFile = "${{ github.workspace }}\logs\sysmonlike-test-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"
          $transcriptFile = "${{ github.workspace }}\transcripts\sysmonlike-$(Get-Date -Format 'yyyyMMdd-HHmmss').txt"

          Start-Transcript -Path $transcriptFile

          try {
              $scriptPath = "${{ github.workspace }}\scripts\SysmonLikeAudit.ps1"

              if (Test-Path $scriptPath) {
                  Write-Host "Script found at: $scriptPath" -ForegroundColor Green

                  # Syntax check
                  $syntaxErrors = $null
                  $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $scriptPath -Raw), [ref]$syntaxErrors)

                  if ($syntaxErrors.Count -eq 0) {
                      Write-Host "Syntax check passed" -ForegroundColor Green

                      # Execute with logging
                      & $scriptPath -Verbose *>&1 | Tee-Object -FilePath $logFile

                      Write-Host "Script executed successfully" -ForegroundColor Green
                  } else {
                      Write-Host "Syntax errors found:" -ForegroundColor Red
                      $syntaxErrors | ForEach-Object { Write-Host $_ -ForegroundColor Red }
                      throw "Syntax validation failed"
                  }
              } else {
                  throw "Script not found: $scriptPath"
              }
          } catch {
              Write-Host "Error executing script: $_" -ForegroundColor Red
              Add-Content -Path $logFile -Value "ERROR: $_"
              throw
          } finally {
              Stop-Transcript
          }
        shell: pwsh
        continue-on-error: true

      - name: Test Test-EventIDGeneration.ps1 with logging
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Testing: Test-EventIDGeneration.ps1" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan

          $logFile = "${{ github.workspace }}\logs\eventid-test-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"
          $transcriptFile = "${{ github.workspace }}\transcripts\eventid-$(Get-Date -Format 'yyyyMMdd-HHmmss').txt"

          Start-Transcript -Path $transcriptFile

          try {
              $scriptPath = "${{ github.workspace }}\scripts\Test-EventIDGeneration.ps1"

              if (Test-Path $scriptPath) {
                  Write-Host "Script found at: $scriptPath" -ForegroundColor Green

                  # Syntax check
                  $syntaxErrors = $null
                  $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $scriptPath -Raw), [ref]$syntaxErrors)

                  if ($syntaxErrors.Count -eq 0) {
                      Write-Host "Syntax check passed" -ForegroundColor Green

                      # Execute with logging
                      & $scriptPath -Verbose *>&1 | Tee-Object -FilePath $logFile

                      Write-Host "Script executed successfully" -ForegroundColor Green
                  } else {
                      Write-Host "Syntax errors found:" -ForegroundColor Red
                      $syntaxErrors | ForEach-Object { Write-Host $_ -ForegroundColor Red }
                      throw "Syntax validation failed"
                  }
              } else {
                  throw "Script not found: $scriptPath"
              }
          } catch {
              Write-Host "Error executing script: $_" -ForegroundColor Red
              Add-Content -Path $logFile -Value "ERROR: $_"
              throw
          } finally {
              Stop-Transcript
          }
        shell: pwsh
        continue-on-error: true

      - name: Test Generate-SyntheticLogs.ps1 with logging
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Testing: Generate-SyntheticLogs.ps1" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan

          $logFile = "${{ github.workspace }}\logs\synthetic-test-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"
          $transcriptFile = "${{ github.workspace }}\transcripts\synthetic-$(Get-Date -Format 'yyyyMMdd-HHmmss').txt"

          Start-Transcript -Path $transcriptFile

          try {
              $scriptPath = "${{ github.workspace }}\scripts\Generate-SyntheticLogs.ps1"

              if (Test-Path $scriptPath) {
                  Write-Host "Script found at: $scriptPath" -ForegroundColor Green

                  # Syntax check
                  $syntaxErrors = $null
                  $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $scriptPath -Raw), [ref]$syntaxErrors)

                  if ($syntaxErrors.Count -eq 0) {
                      Write-Host "Syntax check passed" -ForegroundColor Green

                      # Execute with parameters and logging
                      & $scriptPath -Count 10 -Verbose *>&1 | Tee-Object -FilePath $logFile

                      Write-Host "Script executed successfully" -ForegroundColor Green
                  } else {
                      Write-Host "Syntax errors found:" -ForegroundColor Red
                      $syntaxErrors | ForEach-Object { Write-Host $_ -ForegroundColor Red }
                      throw "Syntax validation failed"
                  }
              } else {
                  throw "Script not found: $scriptPath"
              }
          } catch {
              Write-Host "Error executing script: $_" -ForegroundColor Red
              Add-Content -Path $logFile -Value "ERROR: $_"
              throw
          } finally {
              Stop-Transcript
          }
        shell: pwsh
        continue-on-error: true

      - name: Validate logs were created
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Validating log files" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan

          $logPath = "${{ github.workspace }}\logs"
          $transcriptPath = "${{ github.workspace }}\transcripts"

          # Check for log files
          $logFiles = Get-ChildItem -Path $logPath -Filter "*.log" -ErrorAction SilentlyContinue
          $transcriptFiles = Get-ChildItem -Path $transcriptPath -Filter "*.txt" -ErrorAction SilentlyContinue

          if ($logFiles.Count -gt 0) {
              Write-Host "Found $($logFiles.Count) log files:" -ForegroundColor Green
              $logFiles | ForEach-Object {
                  $size = (Get-Item $_.FullName).Length
                  Write-Host "  - $($_.Name) (Size: $size bytes)" -ForegroundColor White

                  if ($size -eq 0) {
                      Write-Host "    WARNING: Log file is empty!" -ForegroundColor Yellow
                  }
              }
          } else {
              Write-Host "WARNING: No log files were created!" -ForegroundColor Yellow
          }

          if ($transcriptFiles.Count -gt 0) {
              Write-Host "Found $($transcriptFiles.Count) transcript files:" -ForegroundColor Green
              $transcriptFiles | ForEach-Object {
                  $size = (Get-Item $_.FullName).Length
                  Write-Host "  - $($_.Name) (Size: $size bytes)" -ForegroundColor White

                  if ($size -eq 0) {
                      Write-Host "    WARNING: Transcript file is empty!" -ForegroundColor Yellow
                  }
              }
          } else {
              Write-Host "WARNING: No transcript files were created!" -ForegroundColor Yellow
          }

          # Create validation report
          $validationReport = @{
              Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              LogFilesCount = $logFiles.Count
              TranscriptFilesCount = $transcriptFiles.Count
              LogFiles = @()
              TranscriptFiles = @()
              ValidationPassed = ($logFiles.Count -gt 0 -and $transcriptFiles.Count -gt 0)
          }

          $logFiles | ForEach-Object {
              $validationReport.LogFiles += @{
                  Name = $_.Name
                  Size = (Get-Item $_.FullName).Length
                  Path = $_.FullName
              }
          }

          $transcriptFiles | ForEach-Object {
              $validationReport.TranscriptFiles += @{
                  Name = $_.Name
                  Size = (Get-Item $_.FullName).Length
                  Path = $_.FullName
              }
          }

          # Save validation report
          $validationReport | ConvertTo-Json -Depth 3 | Out-File "${{ github.workspace }}\test-results\log-validation-report.json"

          if (-not $validationReport.ValidationPassed) {
              throw "Log validation failed: Not all expected log files were created"
          }

          Write-Host "Log validation completed successfully" -ForegroundColor Green
        shell: pwsh

      - name: Generate test summary report
        if: always()
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Generating Test Summary Report" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan

          $summary = @{
              Workflow = "${{ github.workflow }}"
              Run = "${{ github.run_number }}"
              Commit = "${{ github.sha }}"
              Branch = "${{ github.ref_name }}"
              Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              Scripts = @()
          }

          # Analyze each script's results
          $scripts = @(
              "win-audit.ps1",
              "SysmonLikeAudit.ps1",
              "Test-EventIDGeneration.ps1",
              "Generate-SyntheticLogs.ps1"
          )

          foreach ($script in $scripts) {
              $logFile = Get-ChildItem "${{ github.workspace }}\logs" -Filter "*$(($script -split '\.')[0])*" -ErrorAction SilentlyContinue | Select-Object -First 1
              $transcriptFile = Get-ChildItem "${{ github.workspace }}\transcripts" -Filter "*$(($script -split '\.')[0])*" -ErrorAction SilentlyContinue | Select-Object -First 1

              $scriptResult = @{
                  Name = $script
                  LogFileCreated = $null -ne $logFile
                  TranscriptCreated = $null -ne $transcriptFile
                  LogFileSize = if ($logFile) { (Get-Item $logFile.FullName).Length } else { 0 }
                  TranscriptSize = if ($transcriptFile) { (Get-Item $transcriptFile.FullName).Length } else { 0 }
                  Status = "Unknown"
              }

              # Check for errors in log file
              if ($logFile -and (Test-Path $logFile.FullName)) {
                  $content = Get-Content $logFile.FullName -Raw
                  if ($content -match "ERROR:") {
                      $scriptResult.Status = "Failed"
                  } else {
                      $scriptResult.Status = "Passed"
                  }
              }

              $summary.Scripts += $scriptResult
          }

          # Save summary
          $summary | ConvertTo-Json -Depth 3 | Out-File "${{ github.workspace }}\test-results\test-summary.json"

          # Display summary
          Write-Host ""
          Write-Host "Test Results:" -ForegroundColor White
          Write-Host "-------------" -ForegroundColor White
          $summary.Scripts | ForEach-Object {
              $statusColor = if ($_.Status -eq "Passed") { "Green" } elseif ($_.Status -eq "Failed") { "Red" } else { "Yellow" }
              Write-Host "$($_.Name): $($_.Status)" -ForegroundColor $statusColor
              Write-Host "  - Log created: $($_.LogFileCreated) (Size: $($_.LogFileSize) bytes)"
              Write-Host "  - Transcript created: $($_.TranscriptCreated) (Size: $($_.TranscriptSize) bytes)"
          }
        shell: pwsh

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: powershell-logs
          path: |
            logs/
            transcripts/
            test-results/

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/

  # Job 2: Validate logs in Docker container
  validate-docker-logs:
    name: Validate Logs in Docker
    runs-on: windows-latest
    needs: test-powershell-scripts
    timeout-minutes: 20
    env:
      # Disable BuildKit for Windows containers
      DOCKER_BUILDKIT: 0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          Write-Host "Building Docker image for log validation..." -ForegroundColor Cyan
          # Explicitly disable BuildKit
          $env:DOCKER_BUILDKIT = "0"

          # Build without platform specification (Windows runner defaults to Windows)
          docker build -t win-audit-log-test:latest -f Dockerfile .

          # Check if build succeeded
          if ($LASTEXITCODE -ne 0) {
              Write-Host "Docker build failed with exit code $LASTEXITCODE" -ForegroundColor Red
              exit 1
          }
        shell: pwsh

      - name: Run container and validate logging
        run: |
          Write-Host "Starting container with logging enabled..." -ForegroundColor Cyan

          # Start container
          docker run -d --name log-test-container win-audit-log-test:latest
          Start-Sleep -Seconds 10

          # Execute scripts with logging inside container
          Write-Host "Testing logging in container..." -ForegroundColor Cyan

          docker exec log-test-container powershell -Command {
              # Enable transcription
              Start-Transcript -Path "C:\pstranscripts\container-test.txt"

              # Run a test script
              & C:\workspace\scripts\Test-EventIDGeneration.ps1 -Verbose

              Stop-Transcript
          }

          # Verify logs were created
          Write-Host "Verifying log files in container..." -ForegroundColor Cyan

          docker exec log-test-container powershell -Command {
              $transcripts = Get-ChildItem -Path "C:\pstranscripts" -Filter "*.txt"

              if ($transcripts.Count -gt 0) {
                  Write-Host "Found $($transcripts.Count) transcript files in container" -ForegroundColor Green
                  $transcripts | ForEach-Object {
                      Write-Host "  - $($_.Name)" -ForegroundColor White
                  }
              } else {
                  Write-Host "ERROR: No transcript files found in container!" -ForegroundColor Red
                  exit 1
              }
          }

          # Copy logs from container
          New-Item -ItemType Directory -Force -Path .\container-logs
          docker cp log-test-container:C:\pstranscripts\. .\container-logs\
          docker cp log-test-container:C:\logs\. .\container-logs\ 2>$null

          Write-Host "Log validation in Docker completed" -ForegroundColor Green
        shell: pwsh

      - name: Cleanup
        if: always()
        run: |
          docker stop log-test-container 2>$null
          docker rm log-test-container 2>$null
        shell: pwsh

      - name: Upload container logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: container-logs
          path: container-logs/