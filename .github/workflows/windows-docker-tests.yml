name: Windows Docker Audit Testing

on:
  push:
    branches:
      - main
      - develop
      - 'claude/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'All'
        type: choice
        options:
          - All
          - AuditConfig
          - EventGeneration
          - Synthetic
          - Integration

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build-and-test:
    name: Build and Test
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Display Docker info
        run: |
          docker version
          docker info

      - name: Build Windows Docker image
        run: |
          Write-Host "Building Windows audit testing container..." -ForegroundColor Cyan
          docker build -t win-audit-test:latest -t win-audit-test:${{ github.sha }} .
        shell: pwsh

      - name: Verify image was created
        run: |
          docker images win-audit-test
        shell: pwsh

      # Create directories for results
      - name: Prepare test directories
        run: |
          New-Item -ItemType Directory -Force -Path .\test-results
          New-Item -ItemType Directory -Force -Path .\synthetic-logs
        shell: pwsh

      # Run Audit Configuration Tests
      - name: Run Audit Configuration Tests
        if: github.event.inputs.test_suite == 'All' || github.event.inputs.test_suite == 'AuditConfig' || github.event_name != 'workflow_dispatch'
        run: |
          Write-Host "Starting Audit Configuration Tests..." -ForegroundColor Cyan
          docker run --rm --name audit-test-container `
            -v "${PWD}\scripts:C:\workspace\scripts" `
            -v "${PWD}\test-results:C:\test-results" `
            win-audit-test:latest `
            powershell -File C:\workspace\scripts\Run-DockerTests.ps1 -TestSuite AuditConfig -OutputFormat JSON -Verbose
        shell: pwsh

      # Run Event Generation Tests
      - name: Run Event Generation Tests
        if: always() && (github.event.inputs.test_suite == 'All' || github.event.inputs.test_suite == 'EventGeneration' || github.event_name != 'workflow_dispatch')
        run: |
          Write-Host "Starting Event Generation Tests..." -ForegroundColor Cyan
          docker run --rm --name event-test-container `
            -v "${PWD}\scripts:C:\workspace\scripts" `
            -v "${PWD}\test-results:C:\test-results" `
            win-audit-test:latest `
            powershell -File C:\workspace\scripts\Run-DockerTests.ps1 -TestSuite EventGeneration -OutputFormat JSON -Verbose
        shell: pwsh

      # Run Synthetic Log Generation Tests
      - name: Run Synthetic Log Generation Tests
        if: always() && (github.event.inputs.test_suite == 'All' || github.event.inputs.test_suite == 'Synthetic' || github.event_name != 'workflow_dispatch')
        run: |
          Write-Host "Starting Synthetic Log Generation Tests..." -ForegroundColor Cyan
          docker run --rm --name synthetic-test-container `
            -v "${PWD}\scripts:C:\workspace\scripts" `
            -v "${PWD}\test-results:C:\test-results" `
            win-audit-test:latest `
            powershell -File C:\workspace\scripts\Run-DockerTests.ps1 -TestSuite Synthetic -OutputFormat JSON -Verbose
        shell: pwsh

      # Run Integration Tests
      - name: Run Integration Tests
        if: always() && (github.event.inputs.test_suite == 'All' || github.event.inputs.test_suite == 'Integration' || github.event_name != 'workflow_dispatch')
        run: |
          Write-Host "Starting Integration Tests..." -ForegroundColor Cyan
          # Integration tests might need a persistent container or specific isolation
          docker run --rm --name integration-test-container `
            --isolation process `
            -v "${PWD}\scripts:C:\workspace\scripts" `
            -v "${PWD}\test-results:C:\test-results" `
            win-audit-test:latest `
            powershell -File C:\workspace\scripts\Run-DockerTests.ps1 -TestSuite Integration -OutputFormat JSON -Verbose
        shell: pwsh

      # Generate Report
      - name: Generate Test Report
        if: always()
        run: |
          $results = @()
          if (Test-Path ".\test-results") {
              Get-ChildItem -Path ".\test-results" -Filter "*.json" -Recurse | ForEach-Object {
                  try {
                      $content = Get-Content $_.FullName -Raw | ConvertFrom-Json
                      $results += $content
                  } catch {
                      Write-Warning "Failed to parse $($_.FullName)"
                  }
              }
          }

          $summary = @{
              Workflow = "${{ github.workflow }}"
              Run = "${{ github.run_number }}"
              Commit = "${{ github.sha }}"
              Branch = "${{ github.ref_name }}"
              Timestamp = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
              TotalTests = ($results.Tests | Measure-Object).Count
              PassedTests = ($results.Tests | Where-Object { $_.Passed -eq $true } | Measure-Object).Count
              FailedTests = ($results.Tests | Where-Object { $_.Passed -eq $false } | Measure-Object).Count
          }

          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "  Test Summary Report" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Total Tests:  $($summary.TotalTests)" -ForegroundColor White
          Write-Host "Passed:       $($summary.PassedTests)" -ForegroundColor Green
          Write-Host "Failed:       $($summary.FailedTests)" -ForegroundColor $(if($summary.FailedTests -gt 0){'Red'}else{'Green'})
          Write-Host ""

          # Export summary
          $summary | ConvertTo-Json | Out-File -FilePath "test-summary.json"

          # Create markdown report
          @"
          # Windows Audit Testing Report

          **Workflow:** ${{ github.workflow }}
          **Run:** #${{ github.run_number }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Timestamp:** $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")

          ## Summary

          | Metric | Count |
          |--------|-------|
          | Total Tests | $($summary.TotalTests) |
          | Passed | $($summary.PassedTests) |
          | Failed | $($summary.FailedTests) |
          | Success Rate | $(if($summary.TotalTests -gt 0){[math]::Round(($summary.PassedTests / $summary.TotalTests) * 100, 2)}else{0})% |

          ## Test Results by Suite

          $(
              $results | ForEach-Object {
                  "### $($_.TestSuite)`n"
                  "- Duration: $([math]::Round($_.Duration, 2)) seconds`n"
                  "- Tests: $($_.Summary.Total)`n"
                  "- Passed: $($_.Summary.Passed)`n"
                  "- Failed: $($_.Summary.Failed)`n"
              }
          )
          "@ | Out-File -FilePath "TEST_REPORT.md"

          Get-Content "TEST_REPORT.md"
        shell: pwsh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            test-summary.json
            TEST_REPORT.md

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('TEST_REPORT.md')) {
              const report = fs.readFileSync('TEST_REPORT.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }
